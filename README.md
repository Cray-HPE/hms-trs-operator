# HMS TRS Operator

## Overview

This repo contains all the pieces to the operator for the TRS project. The lifecycle of this operator is to make sure worker pods are available for handling the work that needs to be done by client applications.

More info available at: https://github.com/Cray-HPE/hms-trs-app-api

## TRS Operator Manual Smoke Testing

1. Install the new cray-hms-trs-operator
2. Create a TRSWorker using the config file [testapp1-http-v1.yaml](deploy/crds/test_crs/testapp1-http-v1.yaml)

    ```bash
    kubectl apply -n services -f testapp1-http-v1.yaml
    kubectl -n services get TRSWorker
    ```

3. Check that the TRS Worker pods were created.

    ```bash
    kubectl -n services get pods | grep trs
    ```

4. Check the logs of the TRS Worker pods for errors.

    ```bash
    kubectl -n services get pods | grep trsworker | awk '{print $1}' | xargs -I{} \
    sh -c 'kubectl logs -n services -c trsworker {}; echo "-----------------"'
    ```

5. Check the logs of TRS Operator for errors.

    ```bash
    kubectl -n operators get pods | grep trs-operator | awk '{print $1}' | xargs -I{} \
    sh -c 'kubectl logs -n operators {}; echo "-----------------"'
    ```

6. When done remove the TRSWorker.

    ```bash
    kubectl delete -n services -f testapp1-http-v1.yaml
    ```

## Generate Source Code Using operator-sdk

This project (hms-trs-operator) contains generated code. The code is generated by a tool called `operator-sdk` (see [operator-sdk](https://sdk.operatorframework.io/)).

The version of `operator-sdk` used by hms-trs-operator is wrapped in the dockerfile [here](operator-sdk/Dockerfile). This docker image is built by the github workflows. It can be used to generate the source code and it should be manually run anytime the source code is changed.

To generate the source code, run the following command from the root of the hms-trs-operator git source.

```bash
docker run -it --rm --network host \
    -v $(pwd):/workdir -w /workdir \
    artifactory.algol60.net/csm-docker/stable/cray-trs-operator-sdk:2.1.0 \
    sh -c "./scripts/generateK8s.sh"
```

Note that on linux running this image may leave some local files owned by root. To work around this, have the docker image change the file owner back.

```bash
docker run -it --rm --network host \
    -v $(pwd):/workdir -w /workdir \
    artifactory.algol60.net/csm-docker/stable/cray-trs-operator-sdk:2.1.0 \
    sh -c "./scripts/generateK8s.sh; chown -R $(id -u):$(id -g) ."
```

The script [scripts/generateK8s.sh](scripts/generateK8s.sh) generates the following files by running: `operator-sdk generate k8s` and `operator-sdk generate crds`.
- [deploy/crds/kafka.strimzi.io_kafkatopics_crd.yaml](deploy/crds/kafka.strimzi.io_kafkatopics_crd.yaml)
- [deploy/crds/trs.hms.cray.com_trsworkers_crd.yaml](deploy/crds/trs.hms.cray.com_trsworkers_crd.yaml)
- [pkg/apis/kafka/v1beta1/zz_generated.deepcopy.go](pkg/apis/kafka/v1beta1/zz_generated.deepcopy.go)
- [pkg/apis/trs/v1alpha1/zz_generated.deepcopy.go](pkg/apis/trs/v1alpha1/zz_generated.deepcopy.go)

The following files are used by the generator. Look at the `+kubebuilder` and `+k8s` annotations.
- [pkg/apis/kafka/v1beta1/kafkatopic_types.go](pkg/apis/kafka/v1beta1/kafkatopic_types.go)
- [pkg/apis/trs/v1alpha1/trsworker_types.go](pkg/apis/trs/v1alpha1/trsworker_types.go)

